FUNCTION ZFM_UTL_SSV_FIND_BP.
*"----------------------------------------------------------------------
*"*"Локальный интерфейс:
*"  TABLES
*"      CT_CLIENT STRUCTURE  ZTB_PRTNRDAT_OLP
*"----------------------------------------------------------------------
field-symbols: <ls_cli_fiz> type ZTB_PRTNRDAT_OLP.

data: lt_docdata_olp type standard table of ZTB_DOCDATA_OLP,
      ls_docdata_olp type ZTB_DOCDATA_OLP,
      lt_but000      type standard table of but000,
      lv_comment     type string value '',
      ls_but000      type but000.

  loop at CT_CLIENT[] assigning <ls_cli_fiz> where PROCESSED ne 1 and ZRES_PARTNER is initial.

    select *
      into table lt_docdata_olp
      from ZTB_DOCDATA_OLP
     where EXTERNAL_ID eq <ls_cli_fiz>-EXTERNAL_ID.
    read table lt_docdata_olp with key EXTERNAL_ID = <ls_cli_fiz>-EXTERNAL_ID numberrow = 1 into ls_docdata_olp.

    select *
      into corresponding fields of table lt_but000
      from but000 as p
      join BUT0ID as i on i~partner  eq p~partner
                      and i~type     eq ls_docdata_olp-TYPEDOC
                      and i~IDNUMBER eq ls_docdata_olp-NUMBERDOC
     where NAME_LAST   eq <ls_cli_fiz>-LASTNAME
       and NAME_FIRST  eq <ls_cli_fiz>-FIRSTNAME
       and NAMEMIDDLE  eq <ls_cli_fiz>-MIDDLENAME
       and ( BIRTHPL   eq <ls_cli_fiz>-BIRTHPLACE or
             BIRTHDT   eq <ls_cli_fiz>-BIRTHDATE
           ).

    if sy-subrc eq 0.
      lv_comment = 'Ошибка: С такой фамилией именем отчеством и (датой) местом рождения ДП '.
      concatenate lv_comment ' уже есть!' into lv_comment.
      <ls_cli_fiz>-PROCESSED   = '2'.
      <ls_cli_fiz>-ZRESULT_MSG = lv_comment.
    else.
      select *
        into corresponding fields of table lt_but000
        from but000 as p
        join BUT0ID as i on i~partner  eq p~partner
         and i~type     eq ls_docdata_olp-TYPEDOC
         and i~IDNUMBER eq ls_docdata_olp-NUMBERDOC.

      if sy-subrc eq 0.
        read table lt_but000 into ls_but000 index 1.
        lv_comment = 'Ошибка: Найден ДП '.
        concatenate lv_comment
                    ls_but000-partner
                    ' c совпадающими идентификационными данными!'
               into lv_comment.
        <ls_cli_fiz>-PROCESSED   = '2'.
        <ls_cli_fiz>-ZRESULT_MSG = lv_comment.
      endif.
    endif.
  endloop.



ENDFUNCTION.